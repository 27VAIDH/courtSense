{
  "project": "SquashIQ PWA v2.0",
  "branchName": "ralph/squashiq-pwa-v2",
  "description": "Transform SquashIQ from local-only PWA to production-ready app with user authentication (Google), cloud sync via Supabase, and social features. Maintains offline-first architecture while enabling multi-device access and real leaderboards.",
  "userStories": [
    {
      "id": "US-P001",
      "title": "Supabase project setup with core database schema",
      "description": "As a developer, I need Supabase backend configured with database schema, RLS policies, and client integration.",
      "acceptanceCriteria": [
        "Create Supabase project at https://supabase.com (free tier, Production mode)",
        "Enable Google OAuth authentication provider (configure client ID/secret in Supabase dashboard)",
        "Install Supabase client: npm install @supabase/supabase-js @supabase/auth-helpers-react",
        "Create src/lib/supabase.ts with initialized client using VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY",
        "Configure .env.local with placeholder values (instructions in comments)",
        "Create database schema SQL file in src/db/supabase-schema.sql with: user_profiles, players, venues, matches, games, rally_analyses, friendships tables",
        "All tables include user_id foreign key to auth.users(id) with ON DELETE CASCADE",
        "All core tables include last_modified_ms BIGINT for sync conflict resolution",
        "Enable Row Level Security on all tables with policy: auth.uid() = user_id",
        "Create performance indexes: matches(user_id, date DESC), players(user_id), venues(user_id)",
        "Set up Supabase Storage bucket: match-photos with RLS allowing users to upload/delete own photos only",
        "Add README-SUPABASE.md with setup instructions (how to create project, run schema, configure env vars)",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Foundation story. Does NOT create tables in Supabase yet - just prepares schema SQL file and client setup. Developer will manually run SQL in Supabase dashboard."
    },
    {
      "id": "US-P002",
      "title": "Authentication UI with Google Sign In",
      "description": "As a user, I want to sign in with my Google account so I can access my data across devices.",
      "acceptanceCriteria": [
        "Create src/pages/AuthPage.tsx - full-screen landing page with dark theme",
        "Hero section with SquashIQ logo, tagline 'Your squash journey, synced across all devices'",
        "Install auth UI: npm install @supabase/auth-ui-react @supabase/auth-ui-shared",
        "Use Supabase Auth UI component: <Auth supabaseClient={supabase} providers={['google']} appearance={{theme, variables}}/>",
        "Custom theme: primary color #00E676, dark background #0A0A0A, surface #1A1A1A",
        "Value props displayed: 'üìä Deep insights', 'üîÑ Never lose data', 'üë• Compete with friends'",
        "Auth callback route /auth/callback processes token exchange and redirects to Dashboard",
        "Create Zustand store src/stores/authStore.ts with user, session, loading state",
        "Protected route wrapper <AuthGuard> redirects to /auth if not logged in",
        "Logout button in Settings: calls supabase.auth.signOut(), clears stores, redirects to /auth",
        "Session persistence: Supabase auto-persists to localStorage, expires after 7 days",
        "Error handling: display user-friendly messages for auth failures",
        "Typecheck passes",
        "Verify in browser: sign in with Google test account, redirected to Dashboard, session persists on refresh"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Google OAuth requires configuration in Google Cloud Console. Setup instructions added to README-SUPABASE.md."
    },
    {
      "id": "US-P003",
      "title": "User profile creation on first sign-in",
      "description": "As a new user, I want a profile automatically created when I sign in for the first time.",
      "acceptanceCriteria": [
        "After successful auth, check if user_profiles record exists for auth.uid()",
        "If not exists: show profile setup modal with username input, display name input (default to email name)",
        "Username validation: 3-20 chars, alphanumeric + underscores, unique (check Supabase)",
        "Create user_profiles record with: id = auth.uid(), username, display_name, privacy_setting = 'friends'",
        "Create default player record with is_current_user = true, name = display_name, user_id = auth.uid()",
        "Store profile completion flag in authStore to prevent re-prompting",
        "If profile exists: skip setup, proceed to Dashboard",
        "Typecheck passes",
        "Verify in browser: new user signs in, prompted for username, profile created in Supabase"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Simple profile setup - just username and display name for MVP. Bio and avatar can be added later."
    },
    {
      "id": "US-P004",
      "title": "Automatic data migration from IndexedDB to Supabase",
      "description": "As an existing user, I want my local match history automatically uploaded when I create an account.",
      "acceptanceCriteria": [
        "On AuthPage load, check if IndexedDB has data: const hasLocalData = (await db.matches.count()) > 0",
        "If hasLocalData && !session: show banner 'You have X matches stored locally. Sign in to back them up!'",
        "After first sign-in, detect if migration needed: check if ANY matches exist in Supabase for user_id",
        "If no server data: show migration modal with progress bar",
        "Migration steps: 1) Upload players (map local IDs to server UUIDs), 2) Upload venues, 3) Upload matches with remapped IDs, 4) Upload games, 5) Upload rally_analyses",
        "Use batch inserts: max 50 records per Supabase request to avoid timeouts",
        "Track migration progress: update modal progress bar (X/Y complete)",
        "Handle errors: if migration fails, show 'Migration paused. Retry?' button, preserve progress",
        "After successful migration: keep local IndexedDB data (becomes cache)",
        "Set migration_completed flag in localStorage to prevent re-running",
        "Typecheck passes",
        "Test: create 10 matches locally, sign in, verify all 10 uploaded to Supabase with correct ID remapping"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Critical for user retention. Must not lose data during migration. Photos handled separately in US-P005."
    },
    {
      "id": "US-P005",
      "title": "Bidirectional sync engine with last-write-wins",
      "description": "As a user, I want my data automatically synced so changes on one device appear on all devices.",
      "acceptanceCriteria": [
        "Create src/lib/sync.ts with sync orchestrator",
        "Sync triggers: app load, after local write (debounced 500ms), window focus, manual (pull-to-refresh)",
        "Push sync: iterate unsynced records (track in Zustand syncStore.dirtyRecords Set), upsert to Supabase",
        "Pull sync: fetch records where last_modified_ms > lastSyncTimestamp (stored in localStorage)",
        "Conflict resolution: compare last_modified_ms, server timestamp > local timestamp ‚Üí overwrite local",
        "Soft deletes: set deleted_at timestamp, sync deletion, remove from local IndexedDB on pull",
        "Retry logic: exponential backoff for failed syncs (1s, 2s, 4s, 8s, max 5 retries)",
        "Sync status indicator in Dashboard header: ‚úÖ Synced (dirtyRecords.size === 0), üîÑ Syncing (dirtyRecords.size > 0), ‚ùå Failed (show Retry button)",
        "Pull-to-refresh gesture on Dashboard triggers manual sync",
        "After each match save: mark record dirty, trigger push sync",
        "Update lastSyncTimestamp after successful pull",
        "Typecheck passes",
        "Test: open 2 browser tabs as same user, create match in Tab A, verify appears in Tab B within 2 sec"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Core sync logic. Last Write Wins is simple but can lose data in rare race conditions - acceptable for MVP."
    },
    {
      "id": "US-P006",
      "title": "Photo upload to Supabase Storage with offline queue",
      "description": "As a user, I want match photos stored in the cloud but still uploadable when offline.",
      "acceptanceCriteria": [
        "Install image compression: npm install browser-image-compression",
        "When user selects photo in match logging: compress to max 1920px width, 85% JPEG quality",
        "Generate filename: {userId}/{matchId}_{timestamp}.jpg",
        "Upload to Supabase Storage: supabase.storage.from('match-photos').upload(filename, blob)",
        "Store public URL in matches.photo_url (NOT base64)",
        "If offline: queue upload in IndexedDB photo_upload_queue table with {matchId, blob, filename}",
        "On app online event: process upload queue, retry failed uploads",
        "Remove from queue after successful upload",
        "Display photos using <img src={photo_url} loading='lazy' />",
        "Delete photo from storage when match deleted: supabase.storage.from('match-photos').remove([filename])",
        "Error handling: if upload fails, show toast 'Photo upload failed', match saves without photo",
        "Typecheck passes",
        "Test: upload photo, verify in Supabase Storage dashboard, go offline, select photo, go online, verify uploaded"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Photo migration from base64 handled separately post-MVP. This story only handles NEW photos."
    },
    {
      "id": "US-P007",
      "title": "Performance optimization - code splitting and bundle size",
      "description": "As a mobile user, I want the app to load fast so I can start logging matches immediately.",
      "acceptanceCriteria": [
        "Use React.lazy() for route-based code splitting: lazy(() => import('./pages/Dashboard'))",
        "Wrap lazy routes in <Suspense fallback={<LoadingSpinner />}>",
        "Run npm run build and analyze bundle: install vite-plugin-bundle-visualizer",
        "Tree-shake Recharts: import specific charts (import {BarChart} from 'recharts') not entire library",
        "Replace heavy libraries if found: check date-fns vs date-fns/esm",
        "Target: main bundle <200KB gzipped (measure with npm run build)",
        "Add pagination to match history: load 20 matches initially, infinite scroll for more (react-intersection-observer)",
        "Memoize expensive insight calculations: wrap in useMemo() with proper dependencies",
        "Update vite-plugin-pwa config: precache fonts, icons, critical CSS",
        "Typecheck passes",
        "Run Lighthouse audit: Performance score 90+ on mobile"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Performance is critical for mobile PWA. Target <2s load time on 3G."
    },
    {
      "id": "US-P008",
      "title": "Touch interactions - swipe gestures and haptic feedback",
      "description": "As a mobile user, I want smooth swipe gestures and haptic feedback for a native-like experience.",
      "acceptanceCriteria": [
        "Install gesture library: npm install @use-gesture/react",
        "Audit all buttons/chips: ensure minimum 44x44px touch targets (add p-2 or p-3 if needed)",
        "Match logging steps: add swipe left/right to navigate Step 1 ‚Üî Step 2 ‚Üî Step 3 (using useDrag hook)",
        "Match cards: swipe left reveals Delete button (iOS-style), swipe right dismisses",
        "Dashboard: pull-to-refresh gesture triggers sync (already in US-P005, ensure gesture works)",
        "Haptic feedback: navigator.vibrate(10) on button press, navigator.vibrate([50,50,50]) on match save success",
        "Respect prefers-reduced-motion: disable haptics if media query matches",
        "Smooth animations: use Framer Motion spring physics for all transitions",
        "Typecheck passes",
        "Test on physical iPhone: verify swipes responsive, haptics trigger correctly"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Haptics via Vibration API (web standard) - works on modern mobile browsers."
    },
    {
      "id": "US-P009",
      "title": "iOS-specific polish - safe areas and PWA install prompt",
      "description": "As an iPhone user, I want the app to respect iOS design patterns and work seamlessly as a PWA.",
      "acceptanceCriteria": [
        "Add safe area CSS: bottom tab bar uses padding-bottom: calc(16px + env(safe-area-inset-bottom))",
        "Header padding: padding-top: calc(16px + env(safe-area-inset-top))",
        "Update index.html meta tags: <meta name='theme-color' content='#0A0A0A'>, <meta name='apple-mobile-web-app-status-bar-style' content='black-translucent'>",
        "Detect if installed: const isInstalled = window.matchMedia('(display-mode: standalone)').matches",
        "If NOT installed: show dismissible banner 'Add SquashIQ to your home screen for the best experience'",
        "Banner includes 'How to Install' instructions: 'Tap Share ‚Üí Add to Home Screen'",
        "Dismiss banner permanently: store flag in localStorage",
        "Generate all icon sizes: 180x180 (home screen), 167x167 (iPad), 152x152, 120x120",
        "Update manifest.json: background_color #0A0A0A, theme_color #0A0A0A",
        "Test scrolling: disable overscroll bounce with overscroll-behavior-y: none on body",
        "Typecheck passes",
        "Test on iOS Safari: verify safe areas correct, install banner appears, app installs via Add to Home Screen"
      ],
      "priority": 9,
      "passes": true,
      "notes": "iOS doesn't support beforeinstallprompt event, so custom banner is best UX."
    },
    {
      "id": "US-P010",
      "title": "Accessibility improvements - WCAG AA compliance",
      "description": "As a user with accessibility needs, I want full keyboard navigation and screen reader support.",
      "acceptanceCriteria": [
        "Replace non-semantic divs: use <button>, <nav>, <main>, <header> elements",
        "All form inputs have associated <label> with htmlFor attribute",
        "Add aria-label to icon-only buttons: <button aria-label='Delete match'>",
        "Sync status uses aria-live='polite' for screen reader announcements",
        "Loading states use role='status', errors use role='alert'",
        "All interactive elements focusable via Tab key",
        "Modal focus trap: can't Tab outside modal, Escape closes modal",
        "Visible focus indicators: add focus-visible:ring-2 focus-visible:ring-primary to all focusables",
        "Run WCAG contrast checker: all text meets 4.5:1 ratio (primary #00E676 on #0A0A0A = 11:1 ‚úì)",
        "Charts have text alternatives: add sr-only text describing data",
        "Test with VoiceOver on iOS: all features usable without vision",
        "Typecheck passes",
        "Run axe DevTools audit: 0 critical violations"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Accessibility should not be an afterthought. Essential for inclusive product."
    },
    {
      "id": "US-P011",
      "title": "Interactive onboarding with sample data",
      "description": "As a new user, I want a guided tutorial so I understand SquashIQ's value immediately.",
      "acceptanceCriteria": [
        "Create 3-step onboarding flow: Step 1 'Log matches in 60 seconds', Step 2 'Discover insights', Step 3 'Track improvement'",
        "Each step has animated illustration (Lottie or auto-playing video)",
        "Step 3 includes 'Start with sample data' button",
        "Sample data generation: create 20 realistic matches with varied opponents (Parth, Hemang, Sarah, Mike), dates (last 90 days), scores, tags",
        "Sample matches saved to IndexedDB with flag sample_data: true",
        "Banner on Dashboard with sample data: 'üëÄ This is sample data. Log your first real match to replace it!'",
        "Clear sample data button in Settings: deletes all records with sample_data flag",
        "Swipeable cards with Framer Motion AnimatePresence",
        "Progress dots (1/3, 2/3, 3/3) at bottom",
        "Skip button in top-right, Get Started button on final step",
        "Store onboarding_completed flag in localStorage, never show again",
        "Typecheck passes",
        "Verify in browser: fresh localStorage, complete onboarding, sample data generated, banner appears"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Sample data is critical for new user activation - they see value immediately without logging 20 matches."
    },
    {
      "id": "US-P012",
      "title": "Advanced search and filtering for matches",
      "description": "As a user with 100+ matches, I want to search and filter so I can find specific matches quickly.",
      "acceptanceCriteria": [
        "Add search bar to Dashboard match history section (sticky at top)",
        "Search placeholder: 'Search matches... (opponent, venue, date, note)'",
        "Debounced search: trigger 300ms after user stops typing",
        "Search by: opponent name (fuzzy), venue name, match note text, date (natural language: 'last week', 'january', '2025-01-15')",
        "Filter dropdown: All | Wins | Losses | Tight Games | This Month",
        "Advanced filters (collapsible): date range picker (from/to), opponent multi-select, venue multi-select, energy level checkboxes, tags multi-select, format (Bo3/Bo5)",
        "URL state management: filters persist in query params ?search=parth&result=win&month=2025-01",
        "Results count: 'Showing 12 of 150 matches'",
        "Empty state: 'No matches found. Try adjusting filters.' with Clear Filters button",
        "If >500 matches: show loading spinner during search (IndexedDB can be slow)",
        "Typecheck passes",
        "Test: create 50 matches, search 'parth', verify filtered, apply Wins filter, verify combined filters work"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Search is critical for power users. Consider minisearch or fuse.js for fuzzy search if performance is poor."
    },
    {
      "id": "US-P013",
      "title": "Friend connections - search and send friend requests",
      "description": "As a user, I want to find my squash buddies and send friend requests so we can compare stats.",
      "acceptanceCriteria": [
        "Add 'Find Friends' section to Profile tab with search bar",
        "Search by username: query Supabase user_profiles.username (case-insensitive ILIKE)",
        "Results show: display_name, @username, bio (truncated), 'Add Friend' button",
        "If already friends: show 'Friends ‚úì' badge",
        "If request pending: show 'Request Sent' (disabled button)",
        "Send friend request: insert to friendships table {user_id: me, friend_id: them, status: 'pending'}",
        "Optimistic UI: button changes to 'Request Sent' immediately",
        "Friend requests inbox on Profile tab: show pending incoming requests",
        "Accept request: update status to 'accepted', set accepted_at timestamp",
        "Create reverse record for bidirectional queries: {user_id: them, friend_id: me, status: 'accepted'}",
        "Decline request: update status to 'declined' (or delete record)",
        "Friends list: display all accepted friends with 'View Profile' button",
        "Typecheck passes",
        "Test: create 2 accounts, send request from A to B, accept from B, verify both see each other in friends list"
      ],
      "priority": 13,
      "passes": true,
      "notes": "Foundation for social features. Privacy controls can be added later (who can send requests, etc.)."
    },
    {
      "id": "US-P014",
      "title": "Friend profiles - view friends' stats",
      "description": "As a user, I want to view my friends' squash stats to celebrate their progress and compete.",
      "acceptanceCriteria": [
        "Create route /profile/:userId for friend profile page",
        "Header: display_name, @username, bio",
        "Privacy-respecting stats based on user_profiles.privacy_setting (default 'friends')",
        "If privacy = 'friends' AND viewer is friend: show overall record, current form (last 5), top 3 insight cards",
        "If privacy = 'public': show stats to everyone",
        "If privacy = 'private': show only name/username, no stats",
        "Stats to display: overall W-L record, last 5 form as colored dots, Win Rate by Opponent, Energy Impact, Current Form",
        "Head-to-head section: if friend is in your opponents list, show 'You vs {name}: X-Y (Z%)'",
        "Interaction buttons: 'Unfriend' (confirmation dialog, deletes both friendship records)",
        "Empty state: 'Friend hasn't logged any matches yet.'",
        "Typecheck passes",
        "Test: view friend profile, verify stats visible, change privacy to private, verify stats hidden"
      ],
      "priority": 14,
      "passes": false,
      "notes": "Privacy is important - users should control who sees their data."
    },
    {
      "id": "US-P015",
      "title": "Global leaderboards with multiple categories",
      "description": "As a competitive user, I want to see how I rank against all SquashIQ users in multiple categories.",
      "acceptanceCriteria": [
        "Add leaderboards section to Rivals tab (below opponent list)",
        "Horizontal scrollable category pills: Overall | Iron Man | Clutch King | Comeback Kid | Hot Streak | Consistency Crown | Most Improved",
        "Tap pill to switch category, one visible at a time",
        "Leaderboard computation: Supabase Edge Function (or manual SQL query for MVP) runs daily at midnight UTC",
        "Aggregates stats for all users with privacy = 'public' OR 'friends' (respecting privacy)",
        "Stores results in leaderboard_cache table: {category, user_id, rank, metric_value, metric_label, computed_at}",
        "Leaderboard UI: ranked list with position number, display_name, metric_label (e.g. '75%', '42 matches')",
        "Highlight current user's row with accent color border",
        "Show 'You are ranked #12 of 345 users'",
        "Friends-only toggle: filter leaderboard to show only accepted friends",
        "Encouraging copy: 'Hemang is on fire this month! üî•' for top rankers",
        "Typecheck passes",
        "Test: create 5 users with varied stats, run computation, verify rankings correct"
      ],
      "priority": 15,
      "passes": false,
      "notes": "Leaderboard computation is complex. Start with simple SQL queries, optimize later. Edge Function can be manual for MVP."
    },
    {
      "id": "US-P016",
      "title": "Private groups for squash clubs",
      "description": "As a club organizer, I want to create a private group so our members can track group-specific stats.",
      "acceptanceCriteria": [
        "Add 'Create Group' button to Rivals tab (opens modal)",
        "Form fields: group name (required), description (optional), privacy (Public | Private)",
        "On create: insert to groups table {name, description, owner_id, privacy}, auto-add owner to group_members with role = 'owner'",
        "Invite members: multi-select from friends list, sends invitation (insert to group_members with pending status for now, or just add directly)",
        "Group detail page /groups/:groupId: header (name, description, member count), members list, 'Edit Group' (owner only), 'Leave Group', 'Delete Group' (owner only)",
        "Group leaderboards: same categories as global, but filtered to group members only",
        "Group activity feed: show recent matches by group members (e.g. 'Hemang logged a win vs Parth (3-1)')",
        "Use Supabase Realtime to update feed live: supabase.channel('group-activity').on('postgres_changes', ...)",
        "Privacy: private groups only viewable by members, public groups viewable by anyone",
        "Typecheck passes",
        "Test: create group, invite friend, verify group leaderboard shows only members, log match, verify activity feed updates"
      ],
      "priority": 16,
      "passes": false,
      "notes": "Groups are powerful for retention - users compete with their regular squash club."
    },
    {
      "id": "US-P017",
      "title": "User tiers and feature flags architecture",
      "description": "As a developer, I need infrastructure for future monetization without building payment flows yet.",
      "acceptanceCriteria": [
        "User tiers already in schema: user_profiles.user_tier ('free' | 'pro' | 'enterprise'), default 'free'",
        "Feature flags already in schema: user_profiles.feature_flags JSONB, default {}",
        "Create helper function: hasFeature(userId, featureName) checks feature_flags AND user_tier",
        "Feature gating UI: create <ProBadge /> component with 'PRO' label",
        "Gated features show lock icon + 'Upgrade to Pro' tooltip",
        "Clicking gated feature shows modal: 'This feature requires Pro. Learn more ‚Üí'",
        "Create static pricing page /pricing: comparison table Free vs Pro vs Enterprise",
        "Free tier: everything current, 5 friends, 2 groups",
        "Pro tier ($5/month): unlimited friends/groups, advanced analytics, priority support",
        "Enterprise tier ($20/month): white-label, API access, team accounts",
        "Pricing page shows 'Coming Soon' badge (no Stripe integration)",
        "Track feature usage in activity_log: {event_type: 'feature_used', event_data: {feature: 'advanced_charts'}}",
        "Typecheck passes",
        "Verify in browser: Pro feature shows lock icon, click opens modal with pricing info"
      ],
      "priority": 17,
      "passes": false,
      "notes": "No payment integration - just architecture. Stripe can be added post-MVP after ‚â•1k users."
    },
    {
      "id": "US-P018",
      "title": "Error monitoring with Sentry",
      "description": "As a developer, I need to monitor errors in production to quickly fix bugs.",
      "acceptanceCriteria": [
        "Create Sentry account at sentry.io (free tier: 5k errors/month)",
        "Install Sentry SDK: npm install @sentry/react @sentry/vite-plugin",
        "Initialize in src/main.tsx: Sentry.init({dsn, integrations: [BrowserTracing, Replay], tracesSampleRate: 0.1, replaysSessionSampleRate: 0.1})",
        "Add Sentry Vite plugin for source maps: sentryVitePlugin({org, project, authToken})",
        "Wrap app in Sentry ErrorBoundary: <Sentry.ErrorBoundary fallback={<ErrorPage />}>",
        "Custom error page: 'Oops! Something went wrong. We've been notified. Please refresh.'",
        "Set user context: Sentry.setUser({id, email, username}) after auth",
        "Add breadcrumbs: Sentry.addBreadcrumb({category: 'match', message: 'Created match'}) on key actions",
        "Configure alerts: email on new error, Slack notification for high-volume errors (optional)",
        "Add VITE_SENTRY_DSN to .env.local (with instructions in README)",
        "Typecheck passes",
        "Test: trigger error (throw in component), verify appears in Sentry dashboard with session replay"
      ],
      "priority": 18,
      "passes": false,
      "notes": "Essential for production. Free tier sufficient for MVP. Session replay is invaluable for debugging."
    }
  ]
}
